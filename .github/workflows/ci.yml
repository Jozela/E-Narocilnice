name: CI/CD Pipeline

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Cache frontend dependencies
        uses: actions/cache@v3
        with:
          path: client/node_modules
          key: frontend-${{ hashFiles('client/package-lock.json') }}

      - name: Install frontend dependencies
        working-directory: client
        run: npm install

      - name: Run frontend tests
        working-directory: client
        run: npm test -- --coverage --watchAll=false

      - name: Upload frontend coverage
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: client/coverage

  backend-tests:
      name: Backend Tests
      runs-on: ubuntu-latest
      steps:
        - name: Checkout repository
          uses: actions/checkout@v3
  
        - name: Set up Python
          uses: actions/setup-python@v4
          with:
            python-version: 3.8
  
        - name: Install dependencies
          run: |
            python -m pip install --upgrade pip
            pip install -r flask-server/requirements.txt
            pip install pytest
  
        - name: Fix Python path
          run: |
            echo "PYTHONPATH=${GITHUB_WORKSPACE}/flask-server" >> $GITHUB_ENV
  
        - name: Debug paths
          run: |
            echo "Workspace: $GITHUB_WORKSPACE"
            echo "PYTHONPATH: $PYTHONPATH"
            echo "Contents of flask-server directory:"
            ls -R flask-server/
  
        - name: Verify server.py is importable
          working-directory: flask-server
          run: |
            python - << 'EOF'
            try:
                from server import app, db, User, Order
                print("IMPORT SUCCESSFUL")
            except Exception as e:
                print("IMPORT FAILED:", e)
                raise
            EOF
  
        - name: Run backend tests
          working-directory: flask-server
          run: |
            echo "Running pytest on all test files..."
            ls -R tests/
            pytest -vv tests/test.py || exit 1


  build:
      name: Build Frontend & Backend
      runs-on: ubuntu-latest
      needs: [frontend-tests, backend-tests]
      steps:
        - uses: actions/checkout@v3
  
        - uses: actions/setup-node@v3
          with:
            node-version: 20
  
        - name: Build frontend
          working-directory: client
          run: |
            npm install
            CI=false npm run build
  
        - name: Upload frontend build
          uses: actions/upload-artifact@v4
          with:
            name: frontend-dist
            path: client/build
  
        - uses: actions/setup-python@v4
          with:
            python-version: 3.8
  
        - name: Prepare backend build
          working-directory: flask-server
          run: |
            pip install -r requirements.txt
            mkdir build
            cp -r . build/
  
        - name: Upload backend build
          uses: actions/upload-artifact@v4
          with:
            name: backend-build
            path: flask-server/build

  docker:
    name: Docker Build & Push (Optional)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v3

      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build Docker image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/my-app:latest .

      - name: Push Docker image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/my-app:latest
